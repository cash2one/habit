(function(window,document,$,undefined){var HSVtoRGB=function(h,s,v){var r,g,b,i,f,p,q,t;i=Math.floor(h*6);f=h*6-i;p=v*(1-s);q=v*(1-f*s);t=v*(1-(1-f)*s);switch(i%6){case 0:r=v,g=t,b=p;break;case 1:r=q,g=v,b=p;break;case 2:r=p,g=v,b=t;break;case 3:r=p,g=q,b=v;break;case 4:r=t,g=p,b=v;break;case 5:r=v,g=p,b=q;break}var hr=Math.floor(r*255).toString(16);var hg=Math.floor(g*255).toString(16);var hb=Math.floor(b*255).toString(16);return"#"+(hr.length<2?"0":"")+hr+(hg.length<2?"0":"")+hg+(hb.length<2?"0":"")+hb};var create_editor=function($textarea,classes,placeholder,toolbar_position,toolbar_buttons,toolbar_submit,label_dropfileclick,placeholder_url,max_imagesize,onImageUpload,onKeyEnter){var wysiwygeditor_insertLink=function(wysiwygeditor,url){if(!url){return wysiwygeditor}var selectedhtml=wysiwygeditor.getSelectedHTML();if(selectedhtml){return wysiwygeditor.insertLink(url)}var html='<a href="'+url.replace(/"/,"&quot;")+'">'+url+"</a>";return wysiwygeditor.insertHTML(html)};var content_insertlink=function(wysiwygeditor,$modify_link){var $button=toolbar_button(toolbar_submit);var $inputurl=$('<input type="text" value="'+($modify_link?$modify_link.attr("href"):"")+'"'+(placeholder_url?' placeholder="'+placeholder_url+'"':"")+" />").addClass("wysiwyg-input").keypress(function(event){if(event.which!=10&&event.which!=13){return}if($modify_link){$modify_link.attr("href",$inputurl.val());wysiwygeditor.closePopup().collapseSelection()}else{try{wysiwygeditor_insertLink(wysiwygeditor,$inputurl.val()).closePopup().collapseSelection()}catch(e){wysiwygeditor.closePopup()}}});var $okaybutton=$button.click(function(event){if($modify_link){$modify_link.attr("href",$inputurl.val());wysiwygeditor.closePopup().collapseSelection()}else{wysiwygeditor_insertLink(wysiwygeditor,$inputurl.val()).closePopup().collapseSelection()}event.stopPropagation();event.preventDefault();return false});var $content=$("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on");$content.append($inputurl).append($okaybutton);return $content};var content_insertimage=function(wysiwygeditor){var insert_image_wysiwyg=function(url,filename){var html='<img id="wysiwyg-insert-image" src="" alt=""'+(filename?' title="'+filename.replace(/"/,"&quot;")+'"':"")+" />";wysiwygeditor.insertHTML(html).closePopup().collapseSelection();var $image=$("#wysiwyg-insert-image").removeAttr("id");if(max_imagesize){$image.css({maxWidth:max_imagesize[0]+"px",maxHeight:max_imagesize[1]+"px"}).load(function(){$image.css({maxWidth:"",maxHeight:""});var image_width=$image.width(),image_height=$image.height();if(image_width>max_imagesize[0]||image_height>max_imagesize[1]){if((image_width/image_height)>(max_imagesize[0]/max_imagesize[1])){image_height=parseInt(image_height/image_width*max_imagesize[0]);image_width=max_imagesize[0]}else{image_width=parseInt(image_width/image_height*max_imagesize[1]);image_height=max_imagesize[1]}$image.attr("width",image_width).attr("height",image_height)}})}$image.attr("src",url)};var $content=$("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on");var $fileuploader=null;if(window.File&&window.FileReader&&window.FileList){var loadImageFromFile=function(file){if(!file.type.match("image.*")){return}var reader=new FileReader();reader.onload=function(event){var dataurl=event.target.result;insert_image_wysiwyg(dataurl,file.name)};reader.readAsDataURL(file)};$fileuploader=$('<input type="file" />').attr("draggable","true").css({position:"absolute",left:0,top:0,width:"100%",height:"100%",opacity:0,cursor:"pointer"}).change(function(event){var files=event.target.files;for(var i=0;i<files.length;++i){loadImageFromFile(files[i])}}).on("dragover",function(event){event.originalEvent.dataTransfer.dropEffect="copy";event.stopPropagation();event.preventDefault();return false}).on("drop",function(event){var files=event.originalEvent.dataTransfer.files;for(var i=0;i<files.length;++i){loadImageFromFile(files[i])}event.stopPropagation();event.preventDefault();return false})}else{if(onImageUpload){var $input=$('<input type="file" />').css({position:"absolute",left:0,top:0,width:"100%",height:"100%",opacity:0,cursor:"pointer"}).change(function(event){onImageUpload.call(this,insert_image_wysiwyg)});$fileuploader=$("<form/>").append($input)}}if($fileuploader){$("<div/>").addClass("wysiwyg-browse").html(label_dropfileclick).append($fileuploader).appendTo($content)}var $button=toolbar_button(toolbar_submit);var $inputurl=$('<input type="text" value=""'+(placeholder_url?' placeholder="'+placeholder_url+'"':"")+" />").addClass("wysiwyg-input").keypress(function(event){if(event.which==10||event.which==13){insert_image_wysiwyg($inputurl.val())}});var $okaybutton=$button.click(function(event){insert_image_wysiwyg($inputurl.val());event.stopPropagation();event.preventDefault();return false});$content.append($("<div/>").append($inputurl).append($okaybutton));return $content};var content_colorpalette=function(wysiwygeditor,forecolor){var $content=$("<table/>").attr("cellpadding","0").attr("cellspacing","0").attr("unselectable","on");
for(var row=1;row<15;++row){var $rows=$("<tr/>");for(var col=0;col<25;++col){var color;if(col==24){var gray=Math.floor(255/13*(14-row)).toString(16);var hexg=(gray.length<2?"0":"")+gray;color="#"+hexg+hexg+hexg}else{var hue=col/24;var saturation=row<=8?row/8:1;var value=row>8?(16-row)/8:1;color=HSVtoRGB(hue,saturation,value)}$("<td/>").addClass("wysiwyg-toolbar-color").attr("title",color).attr("unselectable","on").css({backgroundColor:color}).click(function(){var color=this.title;if(forecolor){wysiwygeditor.forecolor(color).closePopup().collapseSelection()}else{wysiwygeditor.highlight(color).closePopup().collapseSelection()}return false}).appendTo($rows)}$content.append($rows)}return $content};var get_toolbar_handler=function(name,popup_callback){switch(name){case"insertimage":if(!popup_callback){return null}return function(target){popup_callback(content_insertimage(wysiwygeditor),target)};case"insertlink":if(!popup_callback){return null}return function(target){popup_callback(content_insertlink(wysiwygeditor),target)};case"bold":return function(){wysiwygeditor.bold()};case"italic":return function(){wysiwygeditor.italic()};case"underline":return function(){wysiwygeditor.underline()};case"strikethrough":return function(){wysiwygeditor.strikethrough()};case"forecolor":if(!popup_callback){return null}return function(target){popup_callback(content_colorpalette(wysiwygeditor,true),target)};case"highlight":if(!popup_callback){return null}return function(target){popup_callback(content_colorpalette(wysiwygeditor,false),target)};case"alignleft":return function(){wysiwygeditor.align("left")};case"aligncenter":return function(){wysiwygeditor.align("center")};case"alignright":return function(){wysiwygeditor.align("right")};case"alignjustify":return function(){wysiwygeditor.align("justify")};case"subscript":return function(){wysiwygeditor.subscript()};case"superscript":return function(){wysiwygeditor.superscript()};case"indent":return function(){wysiwygeditor.indent()};case"outdent":return function(){wysiwygeditor.indent(true)};case"orderedList":return function(){wysiwygeditor.insertList(true)};case"unorderedList":return function(){wysiwygeditor.insertList()};case"removeformat":return function(){wysiwygeditor.removeFormat().closePopup().collapseSelection()}}return null};var toolbar_button=function(button){return $("<a/>").addClass("wysiwyg-toolbar-icon").attr("href","#").attr("title",button.title).attr("unselectable","on").append(button.image)};var add_buttons_to_toolbar=function($toolbar,selection,popup_open_callback,popup_position_callback){$.each(toolbar_buttons,function(key,value){if(!value){return}if(selection===false&&"showstatic" in value&&!value.showstatic){return}if(selection===true&&"showselection" in value&&!value.showselection){return}var toolbar_handler;if("click" in value){toolbar_handler=function(target){value.click($(target))}}else{if("popup" in value){toolbar_handler=function(target){var $popup=popup_open_callback();var apply_position=value.popup($popup,$(target));if(apply_position!==false){popup_position_callback($popup,target)}}}else{toolbar_handler=get_toolbar_handler(key,function($content,target){var $popup=popup_open_callback();$popup.append($content);popup_position_callback($popup,target);$popup.find("input[type=text]:first").focus()})}}var $button;if(toolbar_handler){$button=toolbar_button(value).click(function(event){toolbar_handler(event.currentTarget);if(get_toolbar_handler(key)){wysiwygeditor.getElement().focus()}event.stopPropagation();event.preventDefault();return false})}else{if(value.html){$button=$(value.html)}}if($button){$toolbar.append($button)}})};var fixed_parent=function(){var parent_fixed=false;$(wysiwygeditor.getElement()).parents().each(function(index,element){if($(element).css("position")=="fixed"){parent_fixed=true;return false}});return parent_fixed};var fixed_offset=function($element){var offset={left:0,top:0};var node=$element.get(0);while(node){offset.left+=node.offsetLeft;offset.top+=node.offsetTop;node=node.offsetParent}return offset};var hotkeys={};var create_wysiwyg=function($textarea,$container,placeholder){var option={element:$textarea.get(0),onkeypress:function(code,character,shiftKey,altKey,ctrlKey,metaKey){if(onKeyEnter&&(code==10||code==13)&&!shiftKey&&!altKey&&!ctrlKey&&!metaKey){return onKeyEnter.call(wysiwygeditor.getElement())}if(character&&!shiftKey&&!altKey&&ctrlKey&&!metaKey){var hotkey=character.toLowerCase();if(!hotkeys[hotkey]){return}hotkeys[hotkey]();return false}},onselection:function(collapsed,rect,nodes,rightclick){var show_toolbar=true,$special_toolbar=null;if(nodes.length==1&&$(nodes[0]).parents("a").length!=0){$special_toolbar=content_insertlink(wysiwygeditor,$(nodes[0]).parents("a:first"))}else{if(rightclick){}else{if(toolbar_position!="selection"&&toolbar_position!="top-selection"&&toolbar_position!="bottom-selection"){show_toolbar=false}else{if(rect===undefined||collapsed){show_toolbar=false}else{if(nodes.length==1&&nodes[0].nodeName=="IMG"){show_toolbar=false
}}}}}if(!show_toolbar){wysiwygeditor.closePopup();return}var $toolbar;var apply_toolbar_position=function(){var offset=fixed_offset($(wysiwygeditor.getElement()));var toolbar_width=$toolbar.outerWidth();var left=offset.left+rect.left+parseInt(rect.width/2)-parseInt(toolbar_width/2);var top=offset.top+rect.top+rect.height;var viewport_width=$(window).width();if(left+toolbar_width>viewport_width-1){left=viewport_width-toolbar_width-1}var scroll_left=fixed_parent()?0:$(window).scrollLeft();if(left<scroll_left+1){left=scroll_left+1}$toolbar.css({left:left+"px",top:top+"px",overflow:"visible"})};$toolbar=$(wysiwygeditor.openPopup());if($toolbar.hasClass("wysiwyg-popup")&&!$toolbar.hasClass("wysiwyg-arrowtop")){$toolbar=$(wysiwygeditor.closePopup().openPopup())}if(!$toolbar.hasClass("wysiwyg-popup")){$toolbar.addClass("wysiwyg-popup wysiwyg-arrowtop").css("position",fixed_parent()?"fixed":"absolute");if($special_toolbar){$toolbar.empty().append($special_toolbar)}else{add_buttons_to_toolbar($toolbar,true,function(){return $toolbar.empty()},function($popup){apply_toolbar_position()})}}apply_toolbar_position()},hijackcontextmenu:(toolbar_position=="selection")};if(placeholder){var $placeholder=$("<div/>").addClass("wysiwyg-placeholder").html(placeholder).hide();$container.prepend($placeholder);option.onplaceholder=function(visible){if(visible){$placeholder.show()}else{$placeholder.hide()}}}var wysiwygeditor=wysiwyg(option);return wysiwygeditor};var $container=$("<div/>").addClass("wysiwyg-container");if(classes){$container.addClass(classes)}$textarea.wrap($container);$container=$textarea.parent(".wysiwyg-container");var $wrapper=false;if(placeholder){$wrapper=$("<div/>").addClass("wysiwyg-wrapper").click(function(){wysiwygeditor.getElement().focus()});$textarea.wrap($wrapper);$wrapper=$textarea.parent(".wysiwyg-wrapper")}var wysiwygeditor=create_wysiwyg($textarea,placeholder?$wrapper:$container,placeholder);if(wysiwygeditor.legacy){var $textarea=$(wysiwygeditor.getElement());$textarea.addClass("wysiwyg-textarea");if($textarea.is(":visible")){$textarea.width($container.width()-($textarea.outerWidth()-$textarea.width()))}}else{$(wysiwygeditor.getElement()).addClass("wysiwyg-editor")}var commands={};$.each(toolbar_buttons,function(key,value){if(!value||!value.hotkey){return}var toolbar_handler=get_toolbar_handler(key);if(!toolbar_handler){return}hotkeys[value.hotkey.toLowerCase()]=toolbar_handler;commands[key]=toolbar_handler});if(toolbar_position!="selection"){var toolbar_top=toolbar_position=="top"||toolbar_position=="top-selection";var $toolbar=$("<div/>").addClass("wysiwyg-toolbar").addClass(toolbar_top?"wysiwyg-toolbar-top":"wysiwyg-toolbar-bottom");add_buttons_to_toolbar($toolbar,false,function(){var $popup=$(wysiwygeditor.openPopup());if($popup.hasClass("wysiwyg-popup")&&$popup.hasClass("wysiwyg-arrowtop")){$popup=$(wysiwygeditor.closePopup().openPopup())}if(!$popup.hasClass("wysiwyg-popup")){$popup.addClass("wysiwyg-popup").css("position",fixed_parent()?"fixed":"absolute")}return $popup},function($popup,target){var $button=$(target);var popup_width=$popup.outerWidth();var offset=fixed_offset($button);var left=offset.left+parseInt($button.width()/2)-parseInt(popup_width/2);var top=offset.top;if(toolbar_top){top+=$button.outerHeight()}else{top-=$popup.height()}var viewport_width=$(window).width();if(left+popup_width>viewport_width-1){left=viewport_width-popup_width-1}var scroll_left=fixed_parent()?0:$(window).scrollLeft();if(left<scroll_left+1){left=scroll_left+1}$popup.css({left:left+"px",top:top+"px",overflow:"visible"})});if(toolbar_top){$container.prepend($toolbar)}else{$container.append($toolbar)}}return{wysiwygeditor:wysiwygeditor,$container:$container}};$.fn.wysiwyg=function(option,param){if(!option||typeof(option)==="object"){option=$.extend({},option);return this.each(function(){var $that=$(this);if($that.data("wysiwyg")){return}var classes=option.classes,placeholder=option.placeholder||$that.attr("placeholder"),toolbar_position=(option.toolbar&&(option.toolbar=="top"||option.toolbar=="top-selection"||option.toolbar=="bottom"||option.toolbar=="bottom-selection"||option.toolbar=="selection"))?option.toolbar:"top-selection",toolbar_buttons=option.buttons,toolbar_submit=option.submit,label_dropfileclick=option.dropfileclick,placeholder_url=option.placeholderUrl||null,max_imagesize=option.maxImageSize||null,onImageUpload=option.onImageUpload,onKeyEnter=option.onKeyEnter;var data=create_editor($that,classes,placeholder,toolbar_position,toolbar_buttons,toolbar_submit,label_dropfileclick,placeholder_url,max_imagesize,onImageUpload,onKeyEnter);$that.data("wysiwyg",data)})}else{if(this.length==1){var data=this.data("wysiwyg");if(!data){return this}if(option=="container"){return data.$container}if(option=="shell"){return data.wysiwygeditor}}}return this}})(window,document,jQuery);
