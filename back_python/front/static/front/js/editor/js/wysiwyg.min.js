(function(window,document,navigator,undefined){var debounce=function(callback,wait,cancelprevious){var timeout;return function(){if(timeout){if(!cancelprevious){return}clearTimeout(timeout)}var context=this,args=arguments;timeout=setTimeout(function(){timeout=null;callback.apply(context,args)},wait)}};var addEvent=function(element,type,handler){if(element.addEventListener){element.addEventListener(type,handler,false)}else{if(element.attachEvent){element.attachEvent("on"+type,handler)}else{if(element!=window){element["on"+type]=handler}}}};var removeEvent=function(element,type,handler){if(element.removeEventListener){element.removeEventListener(type,handler,false)}else{if(element.detachEvent){element.detachEvent("on"+type,handler)}else{if(element!=window){element["on"+type]=null}}}};var fireEvent=function(obj,evt,bubbles,cancelable){if(document.createEvent){var event=document.createEvent("Event");event.initEvent(evt,bubbles!==undefined?bubbles:true,cancelable!==undefined?cancelable:false);obj.dispatchEvent(event)}else{if(document.createEventObject){var event=document.createEventObject();obj.fireEvent("on"+evt,event)}else{if(typeof(element["on"+type])=="function"){element["on"+type]()}}}};var cancelEvent=function(e){if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}return false};var Node_ELEMENT_NODE=typeof(Node)!="undefined"?Node.ELEMENT_NODE:1;var Node_TEXT_NODE=typeof(Node)!="undefined"?Node.TEXT_NODE:3;var isOrContainsNode=function(ancestor,descendant){var node=descendant;while(node){if(node===ancestor){return true}node=node.parentNode}return false};var nextNode=function(node,container){if(node.firstChild){return node.firstChild}while(node){if(node==container){return null}if(node.nextSibling){return node.nextSibling}node=node.parentNode}return null};var saveSelection=function(containerNode){if(window.getSelection){var sel=window.getSelection();if(sel.rangeCount>0){return sel.getRangeAt(0)}}else{if(document.selection){var sel=document.selection;return sel.createRange()}}return null};var restoreSelection=function(containerNode,savedSel){if(!savedSel){return}if(window.getSelection){var sel=window.getSelection();sel.removeAllRanges();sel.addRange(savedSel)}else{if(document.selection){savedSel.select()}}};var getSelectionRect=function(){if(window.getSelection){var sel=window.getSelection();if(!sel.rangeCount){return false}var range=sel.getRangeAt(0).cloneRange();if(range.getBoundingClientRect){var rect=range.getBoundingClientRect();if(!rect||(rect.left==0&&rect.top==0&&rect.right==0&&rect.bottom==0)){return false}return{left:parseInt(rect.left),top:parseInt(rect.top),width:parseInt(rect.right-rect.left),height:parseInt(rect.bottom-rect.top)}}}else{if(document.selection){var sel=document.selection;if(sel.type!="Control"){var range=sel.createRange();return{left:range.boundingLeft,top:range.boundingTop,width:range.boundingWidth,height:range.boundingHeight}}}}return false};var getSelectionCollapsed=function(containerNode){if(window.getSelection){var sel=window.getSelection();if(sel.isCollapsed){return true}return false}else{if(document.selection){var sel=document.selection;if(sel.type=="Text"){var range=document.selection.createRange();var textrange=document.body.createTextRange();textrange.moveToElementText(containerNode);textrange.setEndPoint("EndToStart",range);return range.htmlText.length==0}if(sel.type=="Control"){return false}}}return true};var getSelectedNodes=function(containerNode){if(window.getSelection){var sel=window.getSelection();if(!sel.rangeCount){return[]}var nodes=[];for(var i=0;i<sel.rangeCount;++i){var range=sel.getRangeAt(i),node=range.startContainer,endNode=range.endContainer;while(node){if(node!=containerNode){var node_inside_selection=false;if(sel.containsNode){node_inside_selection=sel.containsNode(node,true)}else{var noderange=document.createRange();noderange.selectNodeContents(node);for(var i=0;i<sel.rangeCount;++i){var range=sel.getRangeAt(i);if(range.compareBoundaryPoints(range.START_TO_START,noderange)<=0&&range.compareBoundaryPoints(range.END_TO_END,noderange)>=0){node_inside_selection=true;break}}}if(node_inside_selection){nodes.push(node)}}node=nextNode(node,node==endNode?endNode:containerNode)}}if(nodes.length==0&&isOrContainsNode(containerNode,sel.focusNode)&&sel.focusNode!=containerNode){nodes.push(sel.focusNode)}return nodes}else{if(document.selection){var sel=document.selection;if(sel.type=="Text"){var nodes=[];var range=sel.createRange(),node=containerNode;while(node){if(node!=containerNode&&node.nodeType==Node_ELEMENT_NODE){var noderange=range.duplicate();noderange.moveToElementText(node);if(range.inRange(noderange)){nodes.push(node)}}node=nextNode(node,containerNode)}if(nodes.length==0&&isOrContainsNode(containerNode,document.activeElement)&&document.activeElement!=containerNode){nodes.push(document.activeElement)}return nodes}if(sel.type=="Control"){var nodes=[];var range=sel.createRange();for(var i=0;
i<range.length;++i){nodes.push(range(i))}return nodes}}}return[]};var collapseSelectionEnd=function(){if(window.getSelection){var sel=window.getSelection();if(!sel.isCollapsed){sel.collapseToEnd()}}else{if(document.selection){var sel=document.selection;if(sel.type!="Control"){var range=sel.createRange();range.collapse(false);range.select()}}}};var getSelectionHtml=function(containerNode){if(getSelectionCollapsed(containerNode)){return null}if(window.getSelection){var sel=window.getSelection();if(sel.rangeCount){var container=document.createElement("div"),len=sel.rangeCount;for(var i=0;i<len;++i){var contents=sel.getRangeAt(i).cloneContents();container.appendChild(contents)}return container.innerHTML}}else{if(document.selection){var sel=document.selection;if(sel.type=="Text"){var range=sel.createRange();return range.htmlText}}}return null};var selectionInside=function(containerNode,force){if(window.getSelection){var sel=window.getSelection();if(isOrContainsNode(containerNode,sel.anchorNode)&&isOrContainsNode(containerNode,sel.focusNode)){return true}if(!force){return false}var range=document.createRange();range.selectNodeContents(containerNode);range.collapse(false);sel.removeAllRanges();sel.addRange(range)}else{if(document.selection){var sel=document.selection;if(sel.type=="Control"){var range=sel.createRange();if(range.length!=0&&isOrContainsNode(containerNode,range(0))){return true}}else{var rangeContainer=document.body.createTextRange();rangeContainer.moveToElementText(containerNode);var range=sel.createRange();if(rangeContainer.inRange(range)){return true}}if(!force){return false}var range=document.body.createTextRange();range.moveToElementText(containerNode);range.setEndPoint("StartToEnd",range);range.select()}}return true};var pasteHtmlAtCaret=function(containerNode,html){if(window.getSelection){var sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){var range=sel.getRangeAt(0);var el=document.createElement("div");el.innerHTML=html;var frag=document.createDocumentFragment(),node,lastNode;while((node=el.firstChild)){lastNode=frag.appendChild(node)}if(isOrContainsNode(containerNode,range.commonAncestorContainer)){range.deleteContents();range.insertNode(frag)}else{containerNode.appendChild(frag)}if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range)}}}else{if(document.selection){var sel=document.selection;if(sel.type!="Control"){var originalRange=sel.createRange();originalRange.collapse(true);var range=sel.createRange();if(isOrContainsNode(containerNode,range.parentElement())){range.pasteHTML(html)}else{var textRange=document.body.createTextRange();textRange.moveToElementText(containerNode);textRange.collapse(false);textRange.select();textRange.pasteHTML(html)}range=sel.createRange();range.setEndPoint("StartToEnd",originalRange);range.select()}}}};window.wysiwyg=function(option){option=option||{};var option_element=option.element||null;var option_onkeypress=option.onkeypress||null;var option_onselection=option.onselection||null;var option_onplaceholder=option.onplaceholder||null;var option_hijackcontextmenu=option.hijackcontextmenu||false;var is_textarea=option_element.nodeName=="TEXTAREA"||option_element.nodeName=="INPUT";if(is_textarea){var canContentEditable="contentEditable" in document.body;if(canContentEditable){var webkit=navigator.userAgent.match(/(?:iPad|iPhone|Android).* AppleWebKit\/([^ ]+)/);if(webkit&&420<=parseInt(webkit[1])&&parseInt(webkit[1])<534){canContentEditable=false}}if(!canContentEditable){var node_textarea=option_element;var newlineAfterBR=function(html){return html.replace(/<br[ \/]*>\n?/gi,"<br>\n")};node_textarea.value=newlineAfterBR(node_textarea.value);var dummy_this=function(){return this};var dummy_null=function(){return null};return{legacy:true,getElement:function(){return node_textarea},getHTML:function(){return node_textarea.value},setHTML:function(html){node_textarea.value=newlineAfterBR(html);return this},getSelectedHTML:dummy_null,collapseSelection:dummy_this,openPopup:dummy_null,closePopup:dummy_this,removeFormat:dummy_this,bold:dummy_this,italic:dummy_this,underline:dummy_this,strikethrough:dummy_this,forecolor:dummy_this,highlight:dummy_this,fontName:dummy_this,fontSize:dummy_this,subscript:dummy_this,superscript:dummy_this,align:dummy_this,format:dummy_this,indent:dummy_this,insertLink:dummy_this,insertImage:dummy_this,insertHTML:dummy_this,insertList:dummy_this}}}var node_textarea=null,node_wysiwyg=null;if(is_textarea){node_textarea=option_element;node_textarea.style.display="none";node_wysiwyg=document.createElement("DIV");node_wysiwyg.innerHTML=node_textarea.value;node_textarea.parentNode.insertBefore(node_wysiwyg,node_textarea.nextSibling)}else{node_wysiwyg=option_element}node_wysiwyg.setAttribute("contentEditable","true");var window_ie8=(document.all&&!document.addEventListener)?document:window;var syncTextarea=null;if(is_textarea){var previous_html=node_wysiwyg.innerHTML;syncTextarea=function(){var new_html=node_wysiwyg.innerHTML;
if(new_html==previous_html){return}node_textarea.value=new_html;previous_html=new_html;fireEvent(node_textarea,"change",false)}}var showPlaceholder;if(option_onplaceholder){var placeholder_visible=false;showPlaceholder=function(){var wysiwyg_empty=true;var node=node_wysiwyg;while(node){node=nextNode(node,node_wysiwyg);if(!node){}else{if(node.nodeType==Node_ELEMENT_NODE){if(node.nodeName=="IMG"){wysiwyg_empty=false;break}}else{if(node.nodeType==Node_TEXT_NODE){var text=node.nodeValue;if(text&&text.search(/[^\s]/)!=-1){wysiwyg_empty=false;break}}}}}if(placeholder_visible!=wysiwyg_empty){option_onplaceholder(wysiwyg_empty);placeholder_visible=wysiwyg_empty}};showPlaceholder()}var popup_saved_selection=null,handleSelection=null,debounced_handleSelection=null;if(option_onselection){handleSelection=function(clientX,clientY,rightclick){var collapsed=getSelectionCollapsed(node_wysiwyg);var nodes=getSelectedNodes(node_wysiwyg);var rect=(clientX===null||clientY===null)?null:{left:clientX,top:clientY,width:0,height:0};var selectionRect=getSelectionRect();if(selectionRect){rect=selectionRect}if(rect){if(node_wysiwyg.getBoundingClientRect){var boundingrect=node_wysiwyg.getBoundingClientRect();rect.left-=parseInt(boundingrect.left);rect.top-=parseInt(boundingrect.top)}else{var node=node_wysiwyg,offsetLeft=0,offsetTop=0,fixed=false;do{offsetLeft+=node.offsetLeft?parseInt(node.offsetLeft):0;offsetTop+=node.offsetTop?parseInt(node.offsetTop):0;if(node.style.position=="fixed"){fixed=true}}while(node=node.offsetParent);rect.left-=offsetLeft-(fixed?0:window.pageXOffset);rect.top-=offsetTop-(fixed?0:window.pageYOffset)}if(rect.left<0){rect.left=0}if(rect.top<0){rect.top=0}if(rect.width>node_wysiwyg.offsetWidth){rect.width=node_wysiwyg.offsetWidth}if(rect.height>node_wysiwyg.offsetHeight){rect.height=node_wysiwyg.offsetHeight}}else{if(nodes.length){for(var i=0;i<nodes.length;++i){var node=nodes[i];if(node.nodeType!=Node_ELEMENT_NODE){continue}rect={left:node.offsetLeft,top:node.offsetTop,width:node.offsetWidth,height:node.offsetHeight};break}}}option_onselection(collapsed,rect,nodes,rightclick)};debounced_handleSelection=debounce(handleSelection,1)}var node_popup=null;var popupClickClose=function(e){if(!e){var e=window.event}var target=e.target||e.srcElement;if(target.nodeType==Node_TEXT_NODE){target=target.parentNode}if(isOrContainsNode(node_popup,target)){return}popupClose()};var popupOpen=function(){if(node_popup){return node_popup}addEvent(window_ie8,"mousedown",popupClickClose);node_popup=document.createElement("DIV");document.body.appendChild(node_popup);return node_popup};var popupClose=function(){if(!node_popup){return}node_popup.parentNode.removeChild(node_popup);node_popup=null;removeEvent(window_ie8,"mousedown",popupClickClose)};addEvent(node_wysiwyg,"focus",function(){if(node_textarea){fireEvent(node_textarea,"focus",false)}});addEvent(node_wysiwyg,"blur",function(){if(syncTextarea){syncTextarea()}if(node_textarea){fireEvent(node_textarea,"blur",false)}});var debounced_changeHandler=null;if(showPlaceholder||syncTextarea){var debounced_syncTextarea=syncTextarea?debounce(syncTextarea,50,true):null;var changeHandler=function(e){if(showPlaceholder){showPlaceholder()}if(debounced_syncTextarea){debounced_syncTextarea()}};debounced_changeHandler=debounce(changeHandler,1);addEvent(node_wysiwyg,"input",debounced_changeHandler);addEvent(node_wysiwyg,"DOMNodeInserted",debounced_changeHandler);addEvent(node_wysiwyg,"DOMNodeRemoved",debounced_changeHandler);addEvent(node_wysiwyg,"DOMSubtreeModified",debounced_changeHandler);addEvent(node_wysiwyg,"DOMCharacterDataModified",debounced_changeHandler);addEvent(node_wysiwyg,"propertychange",debounced_changeHandler);addEvent(node_wysiwyg,"textInput",debounced_changeHandler);addEvent(node_wysiwyg,"paste",debounced_changeHandler);addEvent(node_wysiwyg,"cut",debounced_changeHandler);addEvent(node_wysiwyg,"drop",debounced_changeHandler)}var keyHandler=function(e,phase){if(!e){var e=window.event}var code=0;if(e.keyCode){code=e.keyCode}else{if(e.which){code=e.which}}var character=e.charCode;if(phase==1&&option_onkeypress){var rv=option_onkeypress(code,character?String(String):String.fromCharCode(code),e.shiftKey||false,e.altKey||false,e.ctrlKey||false,e.metaKey||false);if(rv===false){return cancelEvent(e)}}if(phase==2||phase==3){popup_saved_selection=null;if(debounced_handleSelection){debounced_handleSelection(null,null,false)}}if(phase==2&&debounced_changeHandler){switch(code){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:break;default:debounced_changeHandler();break}}};addEvent(node_wysiwyg,"keydown",function(e){return keyHandler(e,1)});addEvent(node_wysiwyg,"keypress",function(e){return keyHandler(e,2)});addEvent(node_wysiwyg,"keyup",function(e){return keyHandler(e,3)});var mouseHandler=function(e,rightclick){if(!e){var e=window.event}var clientX=null,clientY=null;if(e.clientX&&e.clientY){clientX=e.clientX;clientY=e.clientY}else{if(e.pageX&&e.pageY){clientX=e.pageX-window.pageXOffset;
clientY=e.pageY-window.pageYOffset}}if(e.which&&e.which==3){rightclick=true}else{if(e.button&&e.button==2){rightclick=true}}removeEvent(window_ie8,"mouseup",mouseHandler);popup_saved_selection=null;if(!option_hijackcontextmenu&&rightclick){return}if(debounced_handleSelection){debounced_handleSelection(clientX,clientY,rightclick)}};addEvent(node_wysiwyg,"mousedown",function(e){removeEvent(window_ie8,"mouseup",mouseHandler);addEvent(window_ie8,"mouseup",mouseHandler)});addEvent(node_wysiwyg,"mouseup",function(e){mouseHandler(e);if(debounced_changeHandler){debounced_changeHandler()}});addEvent(node_wysiwyg,"dblclick",function(e){mouseHandler(e)});addEvent(node_wysiwyg,"selectionchange",function(e){mouseHandler(e)});if(option_hijackcontextmenu){addEvent(node_wysiwyg,"contextmenu",function(e){mouseHandler(e,true);return cancelEvent(e)})}var execCommand=function(command,param,force_selection){restoreSelection(node_wysiwyg,popup_saved_selection);if(!selectionInside(node_wysiwyg,force_selection)){return false}if(window.getSelection){try{if(document.queryCommandSupported&&!document.queryCommandSupported(command)){return false}return document.execCommand(command,false,param)}catch(e){}}else{if(document.selection){var sel=document.selection;if(sel.type!="None"){var range=sel.createRange();try{if(!range.queryCommandEnabled(command)){return false}return range.execCommand(command,false,param)}catch(e){}}}}return false};var callUpdates=function(selection_destroyed){if(showPlaceholder){showPlaceholder()}if(syncTextarea){syncTextarea()}if(selection_destroyed){collapseSelectionEnd();popup_saved_selection=null}else{if(popup_saved_selection){popup_saved_selection=saveSelection(node_wysiwyg)}}};return{getElement:function(){return node_wysiwyg},getHTML:function(){return node_wysiwyg.innerHTML},setHTML:function(html){node_wysiwyg.innerHTML=html;callUpdates(true);return this},getSelectedHTML:function(){restoreSelection(node_wysiwyg,popup_saved_selection);if(!selectionInside(node_wysiwyg)){return null}return getSelectionHtml(node_wysiwyg)},collapseSelection:function(){collapseSelectionEnd();popup_saved_selection=null;return this},openPopup:function(){if(!popup_saved_selection){popup_saved_selection=saveSelection(node_wysiwyg)}return popupOpen()},closePopup:function(){popupClose();return this},removeFormat:function(){execCommand("removeFormat");execCommand("unlink");callUpdates();return this},bold:function(){execCommand("bold");callUpdates();return this},italic:function(){execCommand("italic");callUpdates();return this},underline:function(){execCommand("underline");callUpdates();return this},strikethrough:function(){execCommand("strikeThrough");callUpdates();return this},forecolor:function(color){execCommand("foreColor",color);callUpdates();return this},highlight:function(color){if(!execCommand("hiliteColor",color)){execCommand("backColor",color)}callUpdates();return this},fontName:function(name){execCommand("fontName",name);callUpdates();return this},fontSize:function(size){execCommand("fontSize",size);callUpdates();return this},subscript:function(){execCommand("subscript");callUpdates();return this},superscript:function(){execCommand("superscript");callUpdates();return this},align:function(align){if(align=="left"){execCommand("justifyLeft")}else{if(align=="center"){execCommand("justifyCenter")}else{if(align=="right"){execCommand("justifyRight")}else{if(align=="justify"){execCommand("justifyFull")}}}}callUpdates();return this},format:function(tagname){execCommand("formatBlock",tagname);callUpdates();return this},indent:function(outdent){execCommand(outdent?"outdent":"indent");callUpdates();return this},insertLink:function(url){execCommand("createLink",url);callUpdates(true);return this},insertImage:function(url){execCommand("insertImage",url,true);callUpdates(true);return this},insertHTML:function(html){if(!execCommand("insertHTML",html,true)){restoreSelection(node_wysiwyg,popup_saved_selection);selectionInside(node_wysiwyg,true);pasteHtmlAtCaret(node_wysiwyg,html)}callUpdates(true);return this},insertList:function(ordered){execCommand(ordered?"insertOrderedList":"insertUnorderedList");callUpdates();return this}}}})(window,document,navigator);
