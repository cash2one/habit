{% extends "front/base.html" %}
{% load static %}
{% block navbar-header %}
{% endblock %}
<!-- 内容区 -->
{% block content %}
<div class="container mainPage"  id="main"  ms-controller="main">
  <nav class="navbar navbar-default  navbar-fixed-top" style="z-index:10000" ms-if="isLoading">
    <div  class="col-xs-12 text-center">
        <i style="color:#03BC00;margin-top:10px"  class="fa fa-spinner fa-pulse fa-2x"></i>
    </div>
  </nav>
  <!-- <div class="content" id="content" ms-html="@htmlcontent"> -->
  <div class="content" id="content">
  </div>
  <nav ms-visible="isRoot"  class="navbar navbar-default  navbar-fixed-bottom">
      <div class="container">
        <div class="row navButton">
            <div ms-for="(i,item) in @mainMenu"  class="col-xs-3 col-md-3 text-center sound" style="padding:0px;">
              <a  class="forNav" ms-attr="{'href':'#!'+ item.url,id:item.isDefault?'mainDefault':null}"   ms-click="@focus">
                <span ms-class="['glyphicon',item.icon]"></span>
                <div>{? item.title ?}</div>
              </a>
            </div>
        </div>
      </div>
   </nav>
</div>
<div class="modal fade" id="sysMsg"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <!-- <div class="modal-header">
          <h4 class="modal-title" id="myModalLabel"><i class="fa fa-warning" style="color:orange"></i>系统通知</h4>
        </div> -->
        <div class="text-center" style="width:100%;height:60px;margin-top:15px">
          <p id="contentMsg"></p>
          <div style="margin-top:10px">
            <a href="#" class="button button-pill button-tiny  button-action" id="knowAleady">我知道了</a>
          </div>
       </div>
    </div>
  </div>
</div>
</div>
{% endblock %}
<!-- 主要应用代码区 -->
{% block extrajs %}
<!-- <script src="{% static "front/js/iscroll/iscroll.js" %}"></script> -->
<script src="{% static "front/js/avalon/mmRouter.js" %}"></script>
  <script>
    　　 (function($,$av){
            $(function(){
              //console.log(typeof(avalon))
              var vm=$av.define({
                $id:"main",
                isLoading:true,
                isRoot:true,
                htmlcontent:"hello",
                $refererUrl:null,
                mainMenu:[
                {"title":"活动","url":"/main/activity","icon":"glyphicon-tint","isDefault":true},
                {"title":"成长","url":"/main/grain","icon":"glyphicon-tree-deciduous","isDefault":false},
                {"title":"舞台","url":"/main/sns","icon":"glyphicon-eye-open","isDefault":false},
                {"title":"我的","url":"/main/my","icon":"glyphicon-asterisk","isDefault":false}
                ],
                backClick:function(refererUrl){
                  //$yml.page.$router.pop();
                  this.$refererUrl=refererUrl;
                  console.log("back ......")
                  // var pathArray= $av.router.getLastPath().split("/");
                  // console.log(pathArray);
                  var pathArray= $av.router.getLastPath().split("/");
                  pathArray.pop();
                  var backPath= pathArray.join("/")
                  console.log("backPath......................."+backPath)
                  if(backPath!="/main")
                     console.log(backPath);
                  $av.router.navigate(backPath,1);
                },
                focus:function(el){
                  console.log("focus......")
                  $(".active").removeClass("active")
                  $("span",el.currentTarget).addClass("active")
                  $("div",el.currentTarget).addClass("active")
                }
              });
              function callback(p){
                var refererUrl=null;
                if(vm.currPath)
                  refererUrl=vm.currPath;
                vm.currPath = this.path;
                console.log(this.params)
                var params=this.params;
                vm.isLoading=true;
                fetch(vm.currPath)
                  .then(function(response) {
                    return response.text()
                  }).then(function(body) {
                    $("#content").html(body)
                    //vm.htmlcontent = body
                   vm.isLoading=false;
                    //调用页面的初始化方法
                   var pageVmEleName= $yml.page.getVmEleName();
                   var ele=document.getElementById(pageVmEleName);
                   var  $pageVm=null;
                   if(!$av.vmodels[pageVmEleName]){
                     $pageVm= $yml.page.vmInit();
                     $yml.page.vmInitAfter(vm,$pageVm,params);
                     $av.scan(ele,[vm,$pageVm]);
                   }else{
                     console.log("pageVmEleName "+pageVmEleName+" already exist...")
                     $pageVm=$av.vmodels[pageVmEleName];
                     $av.scan(ele,[vm,$pageVm]);
                     $yml.page.vmInitAfter(vm,$pageVm,params);
                   }
                   //子页面离开时，调用清理方法
                   if(vm.$currentPageVm && vm.$currentPageVm!=$pageVm){
                     vm.$currentPageVm.cleanUp()
                     if(refererUrl){//说明是子页面返回操作
                       //设置当前data-url属性等于子页面url的元素，处于激活状态
                       console.log(refererUrl)
                       var m=function(x){
                         return function(){
                           $("li[data-url='"+x+"']").addClass("active")
                         };
                       }
                       setTimeout(m(refererUrl),100);
                      //  console.log($li)
                       refererUrl=null;
                     }
                   }
                   //保存当前的pageVm
                   vm.$currentPageVm=$pageVm;
                  })
              }
              $av.router.add("/main/activity", callback);
              $av.router.add("/main/activity/detail/:id", callback);
              $av.router.add("/main/grain", callback);
              $av.router.add("/main/sns", callback);
              $av.router.add("/main/my", callback);
              $av.history.start({
                  root: "/main",
                  html5:false,
                  hashPrefix:"!",
                  autoScroll:true //滚动
              })
              //当前页面初次加载时
              var hash = location.hash.replace(/#!?/, '')
              $av.router.navigate(hash || '/main/activity', 0)//默认打开

              $av.scan(document.getElementById("main"),[vm])
              //设置初始激活
              $("span","#mainDefault").addClass("active")
              $("div","#mainDefault").addClass("active")
            })
         })(jQuery,avalon)
  </script>
{% endblock%}
